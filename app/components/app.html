<html>
  <script>
  (function (window) {
    'use strict'

    const document = window.document

    const DEMO_LAYOUT = [
      {w: 1, h: 1, x: 0, y: 0},
      {w: 1, h: 2, x: 0, y: 1},
      {w: 2, h: 2, x: 1, y: 0},
      {w: 1, h: 1, x: 1, y: 2},
      {w: 2, h: 1, x: 2, y: 2},
      {w: 1, h: 1, x: 3, y: 0},
      {w: 1, h: 1, x: 3, y: 1},
      {w: 1, h: 1, x: 4, y: 0},
      {w: 3, h: 1, x: 5, y: 0},
      {w: 2, h: 1, x: 5, y: 1},
      {w: 1, h: 1, x: 5, y: 2},
      {w: 2, h: 1, x: 6, y: 2},
      {w: 1, h: 1, x: 7, y: 1},
      {w: 2, h: 1, x: 8, y: 0},
      {w: 1, h: 1, x: 10, y: 0},
      {w: 1, h: 1, x: 10, y: 1},
      {w: 1, h: 1, x: 10, y: 2}
    ]

    function createItem (content) {

      const h4 = document.createElement('h4')
      h4.classList.add('card-title')
      // h4.textContent = content

      const p = document.createElement('p')
      p.classList.add('card-text')
      // p.textContent = content
      p.textContent = 'x'

      const card = document.createElement('div')
      card.classList.add('card')
      card.classList.add('card-block')
      card.appendChild(h4)
      card.appendChild(p)
      card.draggable = true

      return card
    }

    class TjpAppElement extends window.HTMLDivElement {

      createdCallback () {
        // called BEFORE its children are initialized (in Chrome)
      }

      createDemoDashboards () {
        const keys = [1, 2, 3].map(idx => {

          const key = `db${idx}`
          const name = `Dashboard #${idx}`

          const dashboard = document.createElement('x-grid-list')
          dashboard.setAttribute('direction', 'horizontal')
          dashboard.setAttribute('lanes', '5')

          const onResize = dashboard.grid.onGridContainerResize
          window.addEventListener('resize', onResize)
          window.addEventListener('DOMContentLoaded', onResize)

          this.dom.tabNavs.appendTab(key, name)
          this.dom.tabPanes.appendContent(key, dashboard)

          DEMO_LAYOUT.forEach(pos => {
            const div = createItem(JSON.stringify(pos))
            dashboard.appendGridElement(div, pos)
          })

          return key
        })
      }

      createLocalDom () {
        return {
          tabNavs: this.querySelector('.tjp-tabs'),
          tabPanes: this.querySelector('.tjp-main'),
          menu: this.querySelector('.tjp-menu'),
          widgetSelector: this.querySelector('#widget-selector')
        }
      }

      /** @public */
      initialize () {

        this.widgetFactory = window.tjp.widgetFactory

        this.dom = this.createLocalDom()

        this.createDemoDashboards()
        this.dom.tabNavs.showFirst()

        this.dom.menu.addEventListener('create-widget', (event) => {
          this.showWidgetSelector(event.detail.modelData)
        })

        // resize grid when tab becomes active
        this.dom.tabNavs.addEventListener('tjp-click', (event) => {
          const tab = this.dom.tabPanes.getContent(event.detail.key)
          if (tab) {
            tab.getElementsByTagName('x-grid-list')[0].grid
              .onGridContainerResize()
          }
        })
      }

      setupWidgetSelectorEvents () {

      }

      showWidgetSelector (modelData) {

        const availableWidgets =
          this.widgetFactory.getAvailableWidgetsDescriptors(modelData)

        this.dom.widgetSelector
          .showModal(availableWidgets)
          .then(([tag, descriptor]) => {
            console.log('creating widget', tag)
          })
      }
    }

    window.tjp.util.registerInheritedComponent(TjpAppElement,
                                               'tjp-app',
                                               'div')

  })(window)
  </script>
</html>
