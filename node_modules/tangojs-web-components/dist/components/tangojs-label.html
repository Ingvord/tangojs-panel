<!DOCTYPE html>
<html>

<link rel="import" href="html-led-element.html">

<link rel="import" href="assets/tangojs-common-css.html"
  id="tangojs-common-css">

<template>

  <style>
    #root {
      grid-template-columns: 1fr 1fr 1fr 30px 20px;
    }
    #name  { grid-column: 1; }
    #value { grid-column: 2; }
    #input { grid-column: 3; }
    #unit  { grid-column: 4; }
    #led   { grid-column: 5; }
  </style>

  <div id="root" class="tangojs-form-row">
    <span id="name"></span>
    <span id="value"></span>
    <span id="unit"></span>
    <x-led id="led"></x-led>
  </div>

</template>

<script type="text/javascript">
(function (window) {
  'use strict'

  const currentDocument = window.tangojs.web.util.getCurrentDocument()
  const template = currentDocument.querySelector('template')
  const style = window.tangojs.web.util.importStyleModule('tangojs-common-css',
                                                          'tangojs-form-row')
  template.content.appendChild(style)

  const tangojs = window.tangojs

  class TangoJsLabelElement extends window.HTMLElement {

    createdCallback () {
      this.root = this.createShadowRoot()
      this.dom = this.createLocalDom()
      this.root.appendChild(this.dom.clone)
    }

    createLocalDom () {
      const clone = document.importNode(template.content, true)
      const dom = {
        root: clone.querySelector('#root'),
        name: clone.querySelector('#name'),
        value: clone.querySelector('#value'),
        /* 3rd element is used in line-edit */
        unit: clone.querySelector('#unit'),
        led: clone.querySelector('#led')
      }
      dom.led.on = true
      dom.clone = clone
      return dom
    }

    createProxy (model) {
      const [_, devname, name] = model.match(/^(.+)\/([A-Za-z0-9_]+)$/)
      return new tangojs.proxy.AttributeProxy(devname, name)
    }

    readProxy (proxy) {
      return proxy.read()
    }

    triggerUpdateDueToModelChange () {
      this.proxy[this.model]
        .get_info()
        .then(i => this.updateDueToModelChange(i))
    }

    updateDueToModelChange (attributeInfo) {
      this.dom.name.textContent = attributeInfo.name
      this.dom.unit.textContent = attributeInfo.display_unit
    }

    onModelRead (deviceAttributes) {
      const attribute = deviceAttributes[this.model]
      this.updateValueAndQuality(attribute.value, attribute.quality)
    }

    onModelError (error) {
      console.error(error)
      this.updateValueAndQuality('-error-',
                                 tangojs.tango.AttrQuality.ATTR_INVALID)
    }

    updateValueAndQuality (value, quality) {
      this.dom.led.color = this.getQualityLedColor(quality)
      this.dom.value.textContent = value
    }

    getQualityLedColor (quality) {
      switch (quality) {
        case tangojs.tango.AttrQuality.ATTR_VALID: return '#80FF00'
        case tangojs.tango.AttrQuality.ATTR_INVALID: return '#880088'
        case tangojs.tango.AttrQuality.ATTR_ALARM: return '#FF0000'
        case tangojs.tango.AttrQuality.ATTR_CHANGING: return '#0080FF'
        case tangojs.tango.AttrQuality.ATTR_WARNING: return '#FFFF00'
        default: return '#0000FF'
      }
    }

    toggleVisibility (node, show) {
      node.style.visibility = show ? 'visible' : 'hidden'
    }

    onShowQualityChange (showQuality) {
      this.toggleVisibility(this.dom.led, showQuality)
    }

    onShowNameChange (showName) {
      this.toggleVisibility(this.dom.name, showName)
    }

    onShowUnitChange (showUnit) {
      this.toggleVisibility(this.dom.unit, showUnit)
    }

  }

  window.tangojs.web.util.mixins.withPolledModel.call(
    TangoJsLabelElement.prototype)

  window.tangojs.web.util.mixins.withReflectedAttributes.call(
    TangoJsLabelElement.prototype,
    {
      model: {
        type: 'string',
        onChange: function (model) {
          if (!model) return
          this.onModelChange(model)
          this.triggerUpdateDueToModelChange()
        }
      },
      pollPeriod: {
        type: 'number',
        defaultValue: 1000,
        onChange: TangoJsLabelElement.prototype.onPollPeriodChange
      },
      showQuality: {
        type: 'boolean',
        onChange: TangoJsLabelElement.prototype.onShowQualityChange
      },
      showName: {
        type: 'boolean',
        onChange: TangoJsLabelElement.prototype.onShowNameChange
      },
      showUnit: {
        type: 'boolean',
        onChange: TangoJsLabelElement.prototype.onShowUnitChange
      }
    })

  window.tangojs.web.util.registerComponent('tangojs-label',
                                            TangoJsLabelElement,
                                            {
                                              multipleModels: false,
                                              attributes: true,
                                              commands: false,
                                              status: false,
                                              readOnly: true
                                            },
                                            {
                                              model: {
                                                type: String,
                                                defaultValue: ''
                                              },
                                              poolPeriod: {
                                                type: Number,
                                                defaultValue: 1000
                                              },
                                              showQuality: {
                                                type: Boolean,
                                                defaultValue: true
                                              },
                                              showName: {
                                                type: Boolean,
                                                defaultValue: true
                                              },
                                              showUnit: {
                                                type: Boolean,
                                                defaultValue: true
                                              }
                                            })

})(window)

</script>

</html>
